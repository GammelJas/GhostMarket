<!DOCTYPE html>
<html lang="en">
    <!-- TAB ICON / FAVICON -->
<link rel="icon" type="image/png" sizes="32x32" href="img/skull.png">
<link rel="icon" type="image/png" sizes="16x16" href="img/skull.png">
<link rel="apple-touch-icon" href="img/skull.png">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GhostMarket — Roulette</title>

  <link rel="stylesheet" href="main.css" />

  <!-- Small helpers for topbar + minor UI (no redesign) -->
  <style>
    html{ -webkit-text-size-adjust: 100%; }
    body{ overflow-x:hidden; }

    .topbar{
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 999;
      padding: 14px 16px;
      backdrop-filter: blur(7px);
      background: linear-gradient(180deg, rgba(0,0,0,.62), rgba(0,0,0,.34));
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .topbarInner{
      width:min(1200px, 94vw);
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{ display:flex; flex-direction:column; line-height:1.05; user-select:none; }
    .brandTitle{ color: rgba(210,255,248,.92); letter-spacing:.14em; font-size: 14px; }
    .brandSub{ color: rgba(170,255,240,.72); font-size: 11px; letter-spacing:.10em; opacity:.9; }

    .navLinks{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .navLinks a{
      text-decoration:none;
      font-size:12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: rgba(210,255,248,.80);
      padding: 10px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.32));
      box-shadow: inset 0 0 18px rgba(0,0,0,.70), 0 0 0 1px rgba(0,255,204,.14);
      transition: filter .2s ease, transform .06s ease, box-shadow .2s ease;
    }
    .navLinks a:hover{
      filter: brightness(1.08);
      box-shadow: inset 0 0 18px rgba(0,0,0,.70), 0 0 0 1px rgba(180,0,255,.30), 0 0 22px rgba(180,0,255,.08);
    }

    .hud{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
      color: rgba(170,255,240,.75);
      font-size: 12px;
      letter-spacing: .10em;
      text-transform: uppercase;
    }
    .hud strong{ color: rgba(210,255,248,.92); font-weight: 700; }
    .hudRight{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; }

    .statusPill{
      padding: 8px 10px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.38));
      box-shadow: inset 0 0 18px rgba(0,0,0,.78), 0 0 0 1px rgba(0,255,204,.16);
      color: rgba(210,255,248,.84);
    }

    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter: grayscale(.3);
    }
    .lever.locked{ opacity:.35; cursor:not-allowed; }
    .lever.pulling .leverHandle{
      transform: translateX(-50%) translateY(18px);
    }

    .tinyNote{
      margin-top: 10px;
      color: rgba(170,255,240,.62);
      font-size: 12px;
      letter-spacing: .06em;
      line-height: 1.5;
    }

    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:6px 10px;
      align-items:baseline;
    }
    .k{ color: rgba(210,255,248,.78); letter-spacing:.08em; text-transform:uppercase; font-size: 11px; }
    .v{ color: rgba(170,255,240,.78); font-size: 12px; line-height:1.35; }

    .weaponHint{
      margin: 10px 0 0;
      color: rgba(170,255,240,.65);
      font-size: 12px;
      letter-spacing: .08em;
      line-height: 1.5;
    }

    /* Responsive polish for the right panel without changing desktop look */
    .weaponPanel.gmWeaponPanelFix{
      justify-self: center;
      width: min(350px, 94vw); /* keeps 350px on desktop, scales down on smaller screens */
      max-width: 100%;
    }

    /* Keep your visible watermark (yellow + bigger) */
    .ghostmark-watermark {
      position: fixed;
      bottom: 12px;
      right: 14px;
      font-family: monospace;
      font-size: 20px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: rgb(217, 255, 1);
      pointer-events: none;
      z-index: 9999;
      text-align: right;
    }
  </style>
</head>
<!-- ===============================
     GHOSTMARKET — LOGOUT OVERLAY
     Paste into: main.html + weapons.html + show.html (right before </body>)
================================ -->
<div id="gmLogoutOverlay" class="gm-logout-overlay" aria-hidden="true">
  <div class="gm-logout-wrap" role="dialog" aria-label="Logging out">
    <div class="gm-logout-head">
      <div class="gm-logout-titleBlock">
        <div class="gm-logout-brand">GHOSTMARKET</div>
        <div class="gm-logout-sub">SECURE SIGN-OFF // NODE SHUTDOWN</div>
      </div>

      <div class="gm-logout-status" aria-live="polite">SECURING SESSION…</div>
    </div>

    <div class="gm-logout-body">
      <div class="gm-logout-ring" aria-hidden="true">
        <div class="gm-logout-ringCore"></div>
        <div class="gm-logout-ringDot"></div>
      </div>

      <div class="gm-logout-terminal" aria-label="Shutdown log">
        <div class="gm-logout-log" role="log" aria-live="polite"></div>
      </div>
    </div>

    <div class="gm-logout-foot">
      DO NOT INTERRUPT // LINK DROPPING // GOING OFFLINE
    </div>
  </div>
</div>
<script>
/* ===============================
   GHOSTMARKET — LOGOUT SEQUENCE
   Paste into: main.html + weapons.html + show.html
================================ */
(function(){
  function qs(sel){ return document.querySelector(sel); }

  function clearGhostMarketStorage(){
    try{
      const kill = [];
      for (let i = 0; i < localStorage.length; i++){
        const k = localStorage.key(i);
        if (!k) continue;
        if (k.startsWith("gm_")) kill.push(k);
      }
      kill.forEach(k => localStorage.removeItem(k));

      // extra aliases used in your pages
      localStorage.removeItem("gmSessionId");
      localStorage.removeItem("gm_session_id");
      localStorage.removeItem("gm_session");
    }catch(e){}

    try{ sessionStorage.clear(); }catch(e){}
  }

  function typeLine(logEl, text, msPerChar, done){
    const row = document.createElement("div");
    row.className = "gm-logout-line";

    const caret = document.createElement("span");
    caret.className = "gm-logout-caret";
    caret.textContent = "▌";

    logEl.appendChild(row);

    let i = 0;
    (function tick(){
      i++;
      row.textContent = text.slice(0, i);

      logEl.scrollTop = logEl.scrollHeight;

      if (i < text.length){
        setTimeout(tick, msPerChar);
      } else {
        row.appendChild(caret);
        setTimeout(() => {
          caret.remove();
          done && done();
        }, 90);
      }
    })();
  }

  function runLogoutSequence(redirectTo){
    const overlay = document.getElementById("gmLogoutOverlay");
    if (!overlay){
      // fallback: if you forgot the HTML, just logout normally
      clearGhostMarketStorage();
      window.location.href = redirectTo || "index.html";
      return;
    }

    const logEl = overlay.querySelector(".gm-logout-log");
    const statusEl = overlay.querySelector(".gm-logout-status");

    // reset
    overlay.classList.remove("done");
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
    document.body.classList.add("gm-logout-lock");
    if (logEl) logEl.innerHTML = "";
    if (statusEl) statusEl.textContent = "SECURING SESSION…";

    const totalMs = 4000 + Math.floor(Math.random() * 4001); // 4–8 seconds
    const start = Date.now();

    const lines = [
      ">> INIT: secure sign-off protocol",
      ">> HANDSHAKE: tunnel closing…",
      ">> TOKEN: revoked / session invalidated",
      ">> CACHE: scrubbing local fragments",
      ">> QUEUE: target feed sealed",
      ">> MARKET: listings stream disconnected",
      ">> TRACE: obfuscation pass",
      ">> ROUTE: dropped / node isolating",
      ">> STATUS: OFFLINE"
    ];

    const jitterChar = () => 18 + Math.floor(Math.random() * 34); // per-char speed
    const jitterGap  = () => 140 + Math.floor(Math.random() * 260);

    let idx = 0;

    function finish(){
      overlay.classList.add("done");
      if (statusEl) statusEl.textContent = "OFFLINE // REDIRECTING…";

      setTimeout(() => {
        clearGhostMarketStorage();
        window.location.href = redirectTo || "index.html";
      }, 650);
    }

    function next(){
      if (!logEl) return finish();

      if (idx >= lines.length){
        return finish();
      }

      const text = lines[idx++];
      typeLine(logEl, text, jitterChar(), () => setTimeout(next, jitterGap()));
    }

    next();

    // hard-stop so it always completes within 4–8 sec
    setTimeout(() => {
      if (overlay.classList.contains("show")) finish();
    }, Math.max(0, totalMs - (Date.now() - start)));
  }

  function hookLogoutLinks(){
    const links = Array.from(document.querySelectorAll('a[data-gm-logout]'));
    links.forEach(a => {
      if (a.dataset.gmLogoutBound) return;
      a.dataset.gmLogoutBound = "1";

      a.addEventListener("click", (e) => {
        e.preventDefault();
        runLogoutSequence(a.getAttribute("href") || "index.html");
      });
    });
  }

  document.addEventListener("DOMContentLoaded", hookLogoutLinks);

  // optional manual trigger: window.gmLogout()
  window.gmLogout = () => runLogoutSequence("index.html");
})();
</script>

<body>
  <!-- Film watermark (click area toggles visibility) -->
  <div class="ghostmark-toggle" onclick="toggleGhostmark()">
    <div class="ghostmark-watermark">
      ©Haumann Studio<br>
      FILM PROP — FAKE FAKE FAKE
    </div>
  </div>

  <script>
    function toggleGhostmark() {
      document.body.classList.toggle("ghostmark-hidden");
    }
  </script>

  <div class="page">

    <header class="topbar">
      <div class="topbarInner">
        <div class="brand">
          <div class="brandTitle">GHOSTMARKET</div>
          <div class="brandSub">ROULETTE // TARGET ASSIGNMENT</div>
        </div>

        <nav class="navLinks">
          <a href="main.html">Roulette</a>
          <a href="weapons.html">Weapons</a>
          <a href="index.html" data-gm-logout style="color: rgb(255, 80, 80); font-weight: 900; box-shadow: inset 0 0 18px rgba(0,0,0,.70), 0 0 0 1px rgba(255, 50, 50, .40), 0 0 22px rgba(255, 50, 50, .15);">Log Out</a>
        </nav>
      </div>
    </header>

    <main>
      <!-- LEFT -->
      <section class="roulettePanel" aria-label="Roulette panel">

        <div class="hud">
          <div class="hudLeft">
            RANK: <strong id="rankVal">6</strong>
          </div>

          <div class="hudRight">
            <span class="statusPill" id="cooldownPill">READY</span>
          </div>
        </div>

        <div class="rouletteBox">
          <div class="nameWindow" aria-label="Spinning name window">
            <div class="nameText" id="nameText">—</div>
          </div>

          <div class="lever" id="lever" role="button" tabindex="0" aria-label="Spin lever">
            <div class="leverHandle"></div>
            <div class="leverBase"></div>
          </div>
        </div>

        <div class="decisionRow" aria-label="Accept or decline">
          <button id="acceptBtn" class="btn btnAccept" type="button" disabled>Accept</button>
          <button id="declineBtn" class="btn btnDecline" type="button" disabled>Decline</button>
        </div>

        <div class="tinyNote" id="gateNote">
          Pull the lever to spin. You must <strong>Accept</strong> or <strong>Decline</strong> before the next spin.
        </div>

        <div class="targetPanel" aria-label="Target info panel">
          <div class="targetImage">
            <img id="targetImg" alt="Target photo"/>
          </div>
          <div class="targetData" id="targetData">
            <div class="kv">
              <div class="k">Status</div><div class="v">No target rolled yet.</div>
            </div>
          </div>
        </div>

      </section>

      <!-- RIGHT -->
      <aside class="weaponPanel gmWeaponPanelFix" aria-label="Weapons panel"
        style="
          /* Change weapon image size here */
          --weaponThumbSize: 170px;
        "
      >
        <h2 style="color: rgba(74, 240, 215, 0.92); letter-spacing:.14em; font-size: 25px; margin-bottom: 10px; text-transform: uppercase;">
          Weapon Market
        </h2>

        <div class="weaponGrid" id="weaponGrid"></div>
      </aside>

      <!-- POPUP: RANK LOST -->
      <div class="rankPopup" id="rankPopup" aria-hidden="true">
        <div class="rankBox">
          <h2>RANK LOST</h2>
          <p id="rankPopupText">-1 rank</p>
        </div>
      </div>

      <!-- DATA: people + weapons -->
      <script
        src="./menneske_data.js"
        onload="window.__PEOPLE_OK__=true"
        onerror="window.__PEOPLE_ERR__=true"></script>

      <script
        src="./våben_data.js"
        onload="window.__WEAPONS_OK__=true"
        onerror="window.__WEAPONS_ERR__=true"></script>

      <script>
        const $ = (sel) => document.querySelector(sel);
        const LS = window.localStorage;

        // ====== UI refs
        const nameTextEl = $("#nameText");
        const leverEl = $("#lever");
        const acceptBtn = $("#acceptBtn");
        const declineBtn = $("#declineBtn");
        const rankValEl = $("#rankVal");
        const cooldownPillEl = $("#cooldownPill");
        const targetImgEl = $("#targetImg");
        const targetDataEl = $("#targetData");
        const gateNoteEl = $("#gateNote");
        const rankPopupEl = $("#rankPopup");
        const rankPopupTextEl = $("#rankPopupText");
        const weaponGridEl = $("#weaponGrid");

        // ====== constants
        const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;

        const PLACEHOLDER_IMG =
          "data:image/svg+xml;charset=utf-8," +
          encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="800" height="800">
              <defs>
                <linearGradient id="g" x1="0" x2="1">
                  <stop offset="0" stop-color="#00120e"/>
                  <stop offset="1" stop-color="#090013"/>
                </linearGradient>
              </defs>
              <rect width="100%" height="100%" fill="url(#g)"/>
              <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                font-family="Courier New, monospace" font-size="28" fill="#00ffcc" opacity="0.8">
                IMAGE NOT FOUND
              </text>
            </svg>
          `);

        // ====== session (login)
        function getSessionId(){
          return (
            LS.getItem("gm_session") ||
            LS.getItem("gmSessionId") ||
            LS.getItem("gm_session_id") ||
            ""
          );
        }

        function enforceLogin(){
          const sid = getSessionId();
          if (!sid){
            window.location.href = "index.html";
            return null;
          }
          return sid;
        }

        // ====== data loaders (robust)
        function getPeople(){
          const candidates = [
            // your main data (best)
            window.mennesker,
            window["mennesker"],
            window.people,
            window["people"],
            window.personer,
            window["personer"],
            window.targets,
            window["targets"],

            // IMPORTANT: your menneske_data.js defines window.MENNESKER first
            window.MENNESKER,
            window["MENNESKER"]
          ];

          const found = candidates.find(v => Array.isArray(v) && v.length);
          if (found) return found;

          // fallback (page still loads, but you can see it's wrong)
          return [
            { id: 1, navn: "MISSING menneske_data.js", alder: "-", beskrivelse: "Your menneske_data.js was not found or did not load correctly.", billede: PLACEHOLDER_IMG }
          ];
        }

        function getWeapons(){
          const candidates = [
            window.vaaben,
            window["vaaben"],
            window.vaaben_data,
            window["vaaben_data"],
            window["våben_data"],
            window.weaponsData,
            window.weapons
          ];
          const found = candidates.find(v => Array.isArray(v) && v.length);
          if (found) return found;

          return [
            { id: 1, navn: "MISSING våben_data.js", pris: 0, billede: PLACEHOLDER_IMG }
          ];
        }

        // ====== normalizers
        function normPerson(p, i){
          const id = Number(p.id ?? p._id ?? (i+1));
          const navn = p.navn ?? p.name ?? p.fullname ?? "Unknown";
          const billede = p.billede ?? p.image ?? p.img ?? p.photo ?? "";
          return { ...p, id, navn, billede };
        }

        function normWeapon(w, i){
          const id = Number(w.id ?? w._id ?? (i+1));
          const navn = w.navn ?? w.name ?? w.title ?? "Unknown";
          const pris = Number(w.pris ?? w.price ?? 0);
          const billede = w.billede ?? w.image ?? w.img ?? "";
          return { ...w, id, navn, pris, billede };
        }

        function safeText(x){
          return String(x ?? "").replace(/[&<>"']/g, (m) => ({
            "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
          }[m]));
        }

        function formatDkk(n){
          const num = Number(n || 0);
          return num.toLocaleString("en-US") + " DKK";
        }

        function fmtTime(ms){
          if (ms <= 0) return "00d 00h 00m 00s";
          const s = Math.floor(ms / 1000);
          const d = Math.floor(s / 86400);
          const h = Math.floor((s % 86400) / 3600);
          const m = Math.floor((s % 3600) / 60);
          const ss = s % 60;
          const pad = (x) => String(x).padStart(2, "0");
          return `${pad(d)}d ${pad(h)}h ${pad(m)}m ${pad(ss)}s`;
        }

        function pickNUnique(arr, n){
          const copy = [...arr];
          for (let i = copy.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [copy[i], copy[j]] = [copy[j], copy[i]];
          }
          return copy.slice(0, Math.min(n, copy.length));
        }

        // ====== state
        const state = {
          sessionId: null,
          people: [],
          weapons: [],
          spinning: false,
          pendingDecision: false,
          currentTarget: null,
          cooldownUntil: 0,
          rank: 6
        };

        // ====== storage keys
        const K = {
          rank: "gm_rank",
          cooldownUntil: "gm_cooldown_until",
          spinCounter: "gm_spin_counter",
          lastSessionSeen: "gm_last_session_seen",
          weaponsSession: "gm_weapons_session",
          weaponsPick: "gm_weapons_pick_ids"
        };

        function loadRank(){
          const r = Number(LS.getItem(K.rank));
          state.rank = Number.isFinite(r) && r > 0 ? r : 6;
          rankValEl.textContent = String(state.rank);
        }

        function saveRank(){
          LS.setItem(K.rank, String(state.rank));
          rankValEl.textContent = String(state.rank);
        }

        function loadCooldown(){
          const t = Number(LS.getItem(K.cooldownUntil) || "0");
          state.cooldownUntil = Number.isFinite(t) ? t : 0;
        }

        function saveCooldown(){
          LS.setItem(K.cooldownUntil, String(state.cooldownUntil));
        }

        function clearCooldown(){
          state.cooldownUntil = 0;
          LS.removeItem(K.cooldownUntil);
        }

        function isCooldownActive(){
          return Date.now() < state.cooldownUntil;
        }

        function setUIEnabled(canSpin){
          if (canSpin){
            leverEl.classList.remove("locked");
            leverEl.setAttribute("aria-disabled", "false");
          } else {
            leverEl.classList.add("locked");
            leverEl.setAttribute("aria-disabled", "true");
          }
        }

        function updateCooldownPill(){
          if (isCooldownActive()){
            const left = state.cooldownUntil - Date.now();
            cooldownPillEl.textContent = "COOLDOWN: " + fmtTime(left);
          } else {
            cooldownPillEl.textContent = "READY";
          }
        }

        // ====== target rendering
        function setTargetView(person, statusLine){
          const img = person?.billede ? String(person.billede).replace(/\\/g, "/") : "";
          targetImgEl.src = img ? encodeURI(img) : PLACEHOLDER_IMG;
          targetImgEl.onerror = () => { targetImgEl.src = PLACEHOLDER_IMG; };

          const rows = [];

          const push = (k, v) => {
            if (v === undefined || v === null || String(v).trim() === "") return;
            rows.push(`<div class="k">${safeText(k)}</div><div class="v">${safeText(v)}</div>`);
          };

          if (statusLine) push("Status", statusLine);
          if (person){
            push("Name", person.navn);

            push("Age", person.alder);
            push("City", person.by ?? person.lokation ?? person.sted);
            push("Job", person.job ?? person.erhverv ?? person.stilling);
            push("Rank req", person.rankReq ?? person.rank);
            push("Note", person.note ?? person.notat);
            push("Description", person.beskrivelse ?? person.desc ?? person.description);

            push("Reason", person.reason);
            push("Wanted", person.wanted);
          }

          targetDataEl.innerHTML = `<div class="kv">${rows.join("") || `<div class="k">Status</div><div class="v">—</div>`}</div>`;
        }

        // ====== popup
        function showRankLostPopup(newRank){
          rankPopupTextEl.textContent = `-1 rank (now: ${newRank})`;
          rankPopupEl.classList.add("show");
          rankPopupEl.setAttribute("aria-hidden", "false");
          setTimeout(() => {
            rankPopupEl.classList.remove("show");
            rankPopupEl.setAttribute("aria-hidden", "true");
          }, 1100);
        }

        // ====== decisions gate
        function setDecisionGate(on){
          state.pendingDecision = !!on;
          acceptBtn.disabled = !on;
          declineBtn.disabled = !on;

          if (on){
            gateNoteEl.innerHTML = `You MUST <strong>Accept</strong> or <strong>Decline</strong> before the next spin.`;
          } else {
            gateNoteEl.innerHTML = `Pull the lever to spin. You must <strong>Accept</strong> or <strong>Decline</strong> before the next spin.`;
          }
        }

        // ====== spin logic (ID 1 every other time)
        function chooseFinalTarget(){
          const people = state.people;

          const c = Number(LS.getItem(K.spinCounter) || "0") + 1;
          LS.setItem(K.spinCounter, String(c));

          // every other spin = ID 1 (spin 1,3,5,...)
          const forceId1 = (c % 2 === 1);

          let chosen = null;

          if (forceId1){
            chosen = people.find(p => Number(p.id) === 1) || people[0] || null;
          } else {
            const pool = people.filter(p => Number(p.id) !== 1);
            chosen = (pool.length ? pool : people)[Math.floor(Math.random() * (pool.length ? pool.length : people.length))] || null;
          }

          return chosen;
        }

        function startSpin(){
          if (state.spinning) return;
          if (isCooldownActive()) return;
          if (state.pendingDecision) return;

          if (!state.people.length){
            setTargetView(null, "ERROR: No people loaded.");
            return;
          }

          state.spinning = true;
          setUIEnabled(false);
          leverEl.classList.add("pulling");

          const finalTarget = chooseFinalTarget();
          state.currentTarget = finalTarget;

          // animation: fast -> slower
          const steps = 22;
          let i = 0;
          let delay = 2;

          const tick = () => {
            i++;

            const randomPick = state.people[Math.floor(Math.random() * state.people.length)];
            nameTextEl.textContent = randomPick?.navn ?? "—";

            // slowdown curve
            delay += Math.floor(i * 1.8);

            if (i < steps){
              setTimeout(tick, delay);
            } else {
              nameTextEl.textContent = finalTarget?.navn ?? "—";
              setTargetView(finalTarget, "TARGET ROLLED — Awaiting decision");
              setDecisionGate(true);

              state.spinning = false;
              leverEl.classList.remove("pulling");
              setUIEnabled(false);
            }
          };

          setTimeout(tick, delay);
        }

        // ====== accept / decline
        function acceptTarget(){
          if (!state.pendingDecision) return;
          const t = state.currentTarget;
          if (!t) return;

          state.cooldownUntil = Date.now() + THIRTY_DAYS_MS;
          saveCooldown();

          setDecisionGate(false);
          setTargetView(t, "TARGET ACCEPTED — 30-DAY LOCK");
          setUIEnabled(false);
          updateCooldownPill();
        }

        function declineTarget(){
          if (!state.pendingDecision) return;

          state.rank -= 1;
          saveRank();

          setDecisionGate(false);
          setTargetView(state.currentTarget, "DECLINED — Rank decreased");
          showRankLostPopup(state.rank);

          if (state.rank <= 0){
            LS.setItem(K.rank, "0");
            window.location.href = "index.html";
            return;
          }

          state.currentTarget = null;
          nameTextEl.textContent = "—";
          setUIEnabled(true);
        }

        // ====== weapons (3 random per login)
        function loadOrPickWeaponsForSession(){
          const sid = state.sessionId;

          const last = LS.getItem(K.weaponsSession) || "";
          if (last !== sid){
            LS.setItem(K.weaponsSession, sid);

            const picks = pickNUnique(state.weapons, 3).map(w => w.id);
            LS.setItem(K.weaponsPick, JSON.stringify(picks));
          }

          let ids = [];
          try { ids = JSON.parse(LS.getItem(K.weaponsPick) || "[]"); } catch(e){}
          if (!Array.isArray(ids)) ids = [];

          const byId = new Map(state.weapons.map(w => [Number(w.id), w]));
          const selected = ids.map(id => byId.get(Number(id))).filter(Boolean);

          return selected.length ? selected : pickNUnique(state.weapons, 3);
        }

        function renderWeapons(cards){
          weaponGridEl.innerHTML = "";

          cards.forEach(w => {
            const btn = document.createElement("div");
            btn.className = "weaponCard";
            btn.tabIndex = 0;
            btn.setAttribute("role", "button");
            btn.setAttribute("aria-label", "Open weapon " + (w.navn || w.name || ""));

            const imgSrc = w.billede ? encodeURI(String(w.billede).replace(/\\/g, "/")) : PLACEHOLDER_IMG;

            btn.innerHTML = `
              <div class="weaponThumb"><img alt="${safeText(w.navn)}" /></div>
              <div class="weaponPrice">${safeText(formatDkk(w.pris))}</div>
            `;

            const img = btn.querySelector("img");
            img.src = imgSrc;
            img.onerror = () => { img.src = PLACEHOLDER_IMG; };

            const go = () => {
              try { sessionStorage.setItem('selectedWeapon', JSON.stringify(w)); } catch(e) {}
              window.location.href = 'show.html';
            };

            btn.addEventListener("click", go);
            btn.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") { e.preventDefault(); go(); }
            });

            weaponGridEl.appendChild(btn);
          });
        }

        // ====== session-reset behavior (new login => rank=6 + cooldown reset)
        function handleNewLoginSession(){
          const sid = state.sessionId;
          const seen = LS.getItem(K.lastSessionSeen) || "";

          if (seen !== sid){
            LS.setItem(K.lastSessionSeen, sid);

            state.rank = 6;
            saveRank();
            clearCooldown();
          }
        }

        // ====== attach events
        leverEl.addEventListener("click", () => {
          if (leverEl.classList.contains("locked")) return;
          startSpin();
        });
        leverEl.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            if (leverEl.classList.contains("locked")) return;
            startSpin();
          }
        });

        acceptBtn.addEventListener("click", acceptTarget);
        declineBtn.addEventListener("click", declineTarget);

        // ====== boot
        (function boot(){
          const sid = enforceLogin();
          if (!sid) return;

          state.sessionId = sid;

          state.people = getPeople().map(normPerson);
          state.weapons = getWeapons().map(normWeapon);

          handleNewLoginSession();

          loadRank();
          loadCooldown();

          nameTextEl.textContent = "—";
          setTargetView(null, "Ready");
          setDecisionGate(false);

          const picks = loadOrPickWeaponsForSession();
          renderWeapons(picks);

          const tick = () => {
            updateCooldownPill();

            const canSpin = !isCooldownActive() && !state.pendingDecision && !state.spinning;
            setUIEnabled(canSpin);

            if (isCooldownActive()){
              acceptBtn.disabled = true;
              declineBtn.disabled = true;
            }
          };
          tick();
          setInterval(tick, 1000);

          const canSpinInit = !isCooldownActive() && !state.pendingDecision && !state.spinning;
          setUIEnabled(canSpinInit);

          if (isCooldownActive()){
            gateNoteEl.innerHTML = `You accepted a target. New spins are locked for <strong>30 days</strong> (counting down).`;
          }
        })();
      </script>
    </main>
  </div>
</body>
</html>
